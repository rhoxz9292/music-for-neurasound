import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, SkipForward, SkipBack, Battery, Settings, Activity, Home, Disc, Zap, Moon, Sun, ChevronRight } from 'lucide-react';

// --- STYLES & FONTS INJECTION ---
// We inject the 'Outfit' font and custom keyframe animations here
const GlobalStyles = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;600&display=swap');
    
    body {
      font-family: 'Outfit', sans-serif;
      background-color: #0B0F19;
      color: white;
      overflow-x: hidden;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    .glass-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
    
    .glass-card:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.08);
    }

    .neon-text-cyan {
      text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
    }
    
    .neon-text-purple {
      text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    }

    /* Animations */
    @keyframes breathe {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0; border-width: 0px; }
      50% { opacity: 0.5; border-width: 2px; }
      100% { transform: scale(2.5); opacity: 0; border-width: 0px; }
    }

    @keyframes waveform {
      0% { height: 10%; }
      50% { height: 100%; }
      100% { height: 10%; }
    }

    .animate-breathe { animation: breathe 4s infinite ease-in-out; }
    .animate-float { animation: float 6s infinite ease-in-out; }
    .animate-spin-slow { animation: spin-slow 12s linear infinite; }
    .animate-pulse-ring { animation: pulse-ring 3s infinite cubic-bezier(0.2, 0.6, 0.8, 0.3); }

    /* Custom Scrollbar for hidden look */
    ::-webkit-scrollbar { width: 0px; background: transparent; }
  `}</style>
);

// --- COMPONENT: HALO SYNC (Connection Screen) ---
const HaloSync = ({ onConnect }) => {
  const [status, setStatus] = useState('Searching for Halo Signal...');
  const [connected, setConnected] = useState(false);

  useEffect(() => {
    // Simulate connection process
    const timer1 = setTimeout(() => setStatus('Syncing Neural Link...'), 2000);
    const timer2 = setTimeout(() => {
      setStatus('Neural Link Established');
      setConnected(true);
      if (navigator.vibrate) navigator.vibrate([100, 50, 100]); // Haptic click
    }, 4500);
    const timer3 = setTimeout(onConnect, 6000);

    return () => { clearTimeout(timer1); clearTimeout(timer2); clearTimeout(timer3); };
  }, [onConnect]);

  return (
    <div className="h-screen w-full flex flex-col items-center justify-center relative overflow-hidden bg-[#0B0F19]">
      {/* Background Ambience */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-cyan-500/10 rounded-full blur-[100px]" />

      {/* The Halo */}
      <div className="relative z-10 flex items-center justify-center h-64 w-64">
        {!connected ? (
          <>
            <div className="absolute w-24 h-24 rounded-full border border-cyan-400/30 animate-pulse-ring" />
            <div className="absolute w-24 h-24 rounded-full border border-cyan-400/30 animate-pulse-ring" style={{ animationDelay: '1s' }} />
            <div className="w-4 h-4 bg-cyan-400 rounded-full shadow-[0_0_20px_#06b6d4] animate-ping" />
          </>
        ) : (
          <div className="flex items-center gap-1 h-12 transition-all duration-500">
            {/* Oscilloscope Effect */}
            {[...Array(10)].map((_, i) => (
              <div 
                key={i} 
                className="w-1 bg-cyan-400 rounded-full shadow-[0_0_10px_#06b6d4]"
                style={{ 
                  height: '40px',
                  animation: `waveform 0.6s infinite ease-in-out ${i * 0.1}s` 
                }} 
              />
            ))}
          </div>
        )}
      </div>

      <p className={`mt-8 font-light tracking-[0.2em] text-sm uppercase transition-colors duration-500 ${connected ? 'text-cyan-400 neon-text-cyan' : 'text-gray-400'}`}>
        {status}
      </p>
    </div>
  );
};

// --- COMPONENT: BACKGROUND EFFECTS ---
const TopographicBg = () => (
  <div className="fixed inset-0 z-0 pointer-events-none opacity-30">
    <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-900/20 rounded-full blur-[80px] animate-float" />
    <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-cyan-900/20 rounded-full blur-[80px] animate-float" style={{ animationDelay: '2s' }} />
    <svg className="absolute inset-0 w-full h-full opacity-10" xmlns="http://www.w3.org/2000/svg">
      <filter id="noiseFilter">
        <feTurbulence type="fractalNoise" baseFrequency="0.6" stitchTiles="stitch" />
      </filter>
      <rect width="100%" height="100%" filter="url(#noiseFilter)" />
    </svg>
  </div>
);

// --- COMPONENT: THE INTENT BAR (Simulation) ---
const IntentBar = ({ active, onTrigger }) => {
  const [progress, setProgress] = useState(0);

  // 1. Handle Progress Animation
  useEffect(() => {
    let interval;
    if (active) {
      // Simulate "Focusing" on a command
      interval = setInterval(() => {
        setProgress(prev => {
          const next = prev + 2;
          return next > 100 ? 100 : next;
        });
      }, 30);
    } else {
      // Decay if focus lost
      interval = setInterval(() => {
        setProgress(prev => Math.max(0, prev - 5));
      }, 30);
    }
    return () => clearInterval(interval);
  }, [active]);

  // 2. Handle Trigger separately (Pure effect)
  useEffect(() => {
    if (progress >= 100) {
      onTrigger();
      setProgress(0);
    }
  }, [progress, onTrigger]);

  return (
    <div className="w-full h-1 bg-white/10 rounded-full overflow-hidden mt-2 relative">
      <div className="absolute inset-0 flex items-center justify-center">
        {active && <span className="text-[8px] tracking-widest uppercase text-cyan-200">Processing Intent</span>}
      </div>
      <div 
        className="h-full bg-gradient-to-r from-cyan-500 via-purple-500 to-cyan-500 transition-all duration-100 ease-out shadow-[0_0_10px_#06b6d4]"
        style={{ width: `${progress}%` }}
      />
    </div>
  );
};

// --- COMPONENT: MIND PLAYER ---
const MindPlayer = ({ currentMode, onBack }) => {
  // Start paused to comply with browser autoplay policies usually, 
  // but for simulation we set true. In real app, might need user interaction first.
  const [isPlaying, setIsPlaying] = useState(false); 
  const [intentActive, setIntentActive] = useState(false);
  const [feedback, setFeedback] = useState(null); // 'next', 'vol-up'
  
  // Reference to the real HTML audio element
  const audioRef = useRef(null);

  // Sync React state with HTML Audio Element
  useEffect(() => {
    if (audioRef.current) {
      if (isPlaying) {
        // Promise handling to avoid race conditions/errors
        const playPromise = audioRef.current.play();
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.log("Autoplay prevented or audio error:", error);
            setIsPlaying(false);
          });
        }
      } else {
        audioRef.current.pause();
      }
    }
  }, [isPlaying]);

  // Simulate "Thinking" about Next Track
  const triggerNext = () => {
    if (navigator.vibrate) navigator.vibrate(50);
    setFeedback('next');
    setTimeout(() => setFeedback(null), 1000);
    // In a real app, you would change the audio source here
    console.log("Next track triggered via Neural Intent");
  };

  const handleSimulatedIntent = () => {
    setIntentActive(true);
  };
  const stopSimulatedIntent = () => {
    setIntentActive(false);
  };

  return (
    <div className="h-full flex flex-col items-center justify-between py-6 px-6 relative z-10 animate-fade-in">
      {/* REAL AUDIO ELEMENT (HIDDEN) */}
      {/* Cuando tengas tus archivos, cambia src en Dashboard */}
      <audio 
        ref={audioRef} 
        src={currentMode.audioSrc} 
        loop 
        onEnded={() => setIsPlaying(false)}
      />

      {/* Header */}
      <div className="w-full flex justify-between items-center text-white/50">
        <button onClick={onBack} className="hover:text-white transition-colors"><Home size={20} /></button>
        <span className="text-xs tracking-[0.2em] uppercase">Neural Link: Stable</span>
        <button className="hover:text-white transition-colors"><Settings size={20} /></button>
      </div>

      {/* Visual Feedback Overlays */}
      {feedback === 'next' && (
        <div className="absolute right-4 top-1/2 -translate-y-1/2 z-50 text-cyan-400 animate-pulse">
           <ChevronRight size={64} className="drop-shadow-[0_0_15px_rgba(6,182,212,0.8)]" />
        </div>
      )}

      {/* Main Content */}
      <div className="flex-1 flex flex-col items-center justify-center w-full">
        {/* Album Art */}
        <div className="relative w-64 h-64 mb-12">
          <div className={`absolute inset-0 rounded-full bg-gradient-to-tr ${currentMode.color} opacity-20 blur-3xl animate-pulse`} />
          <div className={`w-full h-full rounded-full border border-white/10 overflow-hidden relative glass-panel shadow-2xl ${isPlaying ? 'animate-spin-slow' : ''}`}>
             {/* Abstract WebGL-ish generated art placeholder */}
             <div className={`w-full h-full bg-gradient-to-br ${currentMode.gradient} opacity-80 mix-blend-overlay`} />
             <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-30" />
          </div>
        </div>

        {/* Track Info */}
        <div className="text-center mb-8 space-y-2">
          <h2 className="text-2xl font-light tracking-wide text-white">{currentMode.trackName || "Etherial Drift"}</h2>
          <p className="text-sm font-mono text-cyan-400/80 tracking-widest uppercase">
            {isPlaying ? "PLAYING • " : "PAUSED • "} {currentMode.name}
          </p>
        </div>

        {/* The Intent Bar - Placed where controls usually are */}
        <div className="w-64 mb-4">
           <IntentBar active={intentActive} onTrigger={triggerNext} />
        </div>
        
        {/* Simulation Tip */}
        <button 
          onMouseDown={handleSimulatedIntent} 
          onMouseUp={stopSimulatedIntent}
          onTouchStart={handleSimulatedIntent}
          onTouchEnd={stopSimulatedIntent}
          className="text-[10px] text-white/30 border border-white/10 px-3 py-1 rounded-full hover:bg-white/5 transition-colors cursor-pointer select-none"
        >
          (Hold to simulate "Next Track" thought)
        </button>

        {/* Hidden Controls (Low Opacity) */}
        <div className="flex items-center gap-8 mt-12 opacity-20 hover:opacity-100 transition-opacity duration-500">
           <SkipBack size={24} />
           <button onClick={() => setIsPlaying(!isPlaying)}>
             {isPlaying ? <Pause size={32} /> : <Play size={32} />}
           </button>
           <SkipForward size={24} />
        </div>
      </div>
    </div>
  );
};

// --- COMPONENT: SENSITIVITY LAB (Settings) ---
const SensitivityLab = ({ onBack }) => {
  const [threshold, setThreshold] = useState(65);
  const [eegData, setEegData] = useState([]);
  
  // Generate fake EEG data
  useEffect(() => {
    const interval = setInterval(() => {
      setEegData(prev => {
        const newData = [...prev, Math.random() * 100];
        if (newData.length > 50) newData.shift();
        return newData;
      });
    }, 50);
    return () => clearInterval(interval);
  }, []);

  // Create SVG path from data
  const getPath = () => {
    if (eegData.length === 0) return "";
    const width = 100; // percent
    const step = width / 50;
    let d = `M 0 ${50 - (eegData[0] / 2 - 25)}`; // normalize somewhat
    eegData.forEach((val, i) => {
      d += ` L ${i * step} ${100 - val}`;
    });
    return d;
  };

  return (
    <div className="h-full flex flex-col p-6 z-10 relative">
      <div className="flex items-center gap-4 mb-8">
        <button onClick={onBack} className="text-white/50 hover:text-white"><Home size={20} /></button>
        <h2 className="text-xl font-light tracking-widest uppercase">Sensitivity Lab</h2>
      </div>

      <div className="glass-panel p-6 rounded-2xl mb-6">
        <div className="flex justify-between items-end mb-4">
           <h3 className="text-xs text-cyan-400 font-mono tracking-widest">RAW EEG FEED</h3>
           <span className="text-xs text-white/50 font-mono">CH-1: FRONTAL CORTEX</span>
        </div>
        
        {/* EEG Graph */}
        <div className="h-32 w-full border-b border-white/10 relative overflow-hidden bg-black/20 rounded-lg">
           <svg className="w-full h-full" preserveAspectRatio="none" viewBox="0 0 100 100">
             <path d={getPath()} fill="none" stroke="#8b5cf6" strokeWidth="0.5" vectorEffect="non-scaling-stroke" />
           </svg>
           {/* Threshold Line */}
           <div 
             className="absolute w-full border-t border-cyan-400/50 border-dashed transition-all duration-300"
             style={{ bottom: `${threshold}%` }}
           />
        </div>
      </div>

      <div className="glass-panel p-6 rounded-2xl space-y-8">
        <div>
          <div className="flex justify-between mb-2">
            <label className="text-sm font-light">Neural Threshold</label>
            <span className="font-mono text-cyan-400">{threshold}%</span>
          </div>
          <input 
            type="range" 
            min="0" 
            max="100" 
            value={threshold} 
            onChange={(e) => setThreshold(e.target.value)}
            className="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-400"
          />
          <p className="text-[10px] text-white/40 mt-2 leading-relaxed">
            Adjusts the intensity of thought required to trigger a command. Higher values reduce false positives but require deeper focus states.
          </p>
        </div>
      </div>
    </div>
  );
};

// --- COMPONENT: DASHBOARD (Neural Hub) ---
const Dashboard = ({ navigate }) => {
  const mood = 'flow'; // 'stress' or 'flow'
  
  // NOTA PARA GITHUB:
  // Reemplaza estas URLs con rutas locales como '/music/mi-archivo.mp3'
  // y pon el archivo en tu carpeta 'public/music'
  const DEMO_AUDIO_1 = "https://actions.google.com/sounds/v1/water/waves_crashing.ogg"; 
  const DEMO_AUDIO_2 = "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg";

  return (
    <div className="h-full flex flex-col p-6 relative z-10 overflow-y-auto pb-20">
      {/* Header */}
      <div className="flex justify-between items-start mb-8">
        <div>
          <h1 className="text-3xl font-thin tracking-tight mb-1">Good Morning, <br/><span className="font-normal text-white">Alex</span></h1>
          <p className="text-xs text-cyan-400/80 font-mono tracking-widest mt-2">SYSTEM OPTIMIZED</p>
        </div>
        <div className="relative w-10 h-10 flex items-center justify-center">
           {/* Custom Battery Icon */}
           <svg viewBox="0 0 36 36" className="w-10 h-10 transform -rotate-90">
             <path className="text-gray-800" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2" />
             <path className="text-cyan-400 drop-shadow-[0_0_5px_#06b6d4]" strokeDasharray="85, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2" />
           </svg>
           <Zap size={12} className="absolute text-white" />
        </div>
      </div>

      {/* Hero Element: The Digital Brain */}
      <div className="flex-1 flex flex-col items-center justify-center mb-8 min-h-[250px]">
        <div className="relative w-48 h-48">
          <div className={`absolute inset-0 rounded-full blur-3xl opacity-40 animate-breathe ${mood === 'flow' ? 'bg-cyan-500' : 'bg-orange-500'}`} />
          <div className="w-full h-full glass-panel rounded-full flex items-center justify-center border border-white/10 relative overflow-hidden">
             {/* Abstract brain-like movement */}
             <div className={`w-32 h-32 rounded-full filter blur-xl opacity-60 mix-blend-screen animate-float ${mood === 'flow' ? 'bg-gradient-to-r from-cyan-400 to-blue-500' : 'bg-gradient-to-r from-orange-400 to-red-500'}`} />
          </div>
        </div>
        <div className="mt-6 text-center">
          <span className="text-4xl font-light text-white tracking-tighter">92%</span>
          <p className="text-xs text-gray-400 uppercase tracking-[0.3em] mt-1">Focus Level</p>
        </div>
      </div>

      {/* Mode Cards */}
      <div className="grid grid-cols-1 gap-4 mb-4">
        <button 
          onClick={() => navigate('player', { 
            name: 'Deep Focus', 
            trackName: 'Beta Waves Stream',
            color: 'from-cyan-500 to-blue-600', 
            gradient: 'from-[#06b6d4] to-[#3b82f6]',
            audioSrc: DEMO_AUDIO_1 // TU ARCHIVO AQUÍ. Ej: "/music/focus.mp3"
          })}
          className="glass-card p-5 rounded-xl flex items-center justify-between group"
        >
          <div className="flex items-center gap-4">
            <div className="p-3 bg-cyan-500/10 rounded-full text-cyan-400 border border-cyan-500/20 group-hover:border-cyan-400/50 transition-colors">
              <Activity size={20} />
            </div>
            <div className="text-left">
              <h3 className="font-light text-lg">Deep Focus</h3>
              <p className="text-xs text-gray-400 font-mono">Beta Waves • 14-30Hz</p>
            </div>
          </div>
          <ChevronRight className="text-white/20 group-hover:text-cyan-400 transition-colors" />
        </button>

        <button 
          onClick={() => navigate('player', { 
            name: 'Relaxation', 
            trackName: 'Alpha Calm',
            color: 'from-purple-500 to-pink-600', 
            gradient: 'from-[#8b5cf6] to-[#ec4899]',
            audioSrc: DEMO_AUDIO_2 // TU ARCHIVO AQUÍ. Ej: "/music/relax.mp3"
          })}
          className="glass-card p-5 rounded-xl flex items-center justify-between group"
        >
          <div className="flex items-center gap-4">
            <div className="p-3 bg-purple-500/10 rounded-full text-purple-400 border border-purple-500/20 group-hover:border-purple-400/50 transition-colors">
              <Moon size={20} />
            </div>
            <div className="text-left">
              <h3 className="font-light text-lg">Relaxation</h3>
              <p className="text-xs text-gray-400 font-mono">Alpha Waves • 8-14Hz</p>
            </div>
          </div>
          <ChevronRight className="text-white/20 group-hover:text-purple-400 transition-colors" />
        </button>
      </div>
    </div>
  );
};

// --- COMPONENT: NAVIGATION BAR ---
const NavBar = ({ activeTab, onNavigate }) => (
  <div className="fixed bottom-6 left-6 right-6 h-16 glass-panel rounded-full flex items-center justify-around px-2 z-50">
    <button 
      onClick={() => onNavigate('dashboard')} 
      className={`p-3 rounded-full transition-all ${activeTab === 'dashboard' ? 'bg-white/10 text-cyan-400 shadow-[0_0_15px_rgba(6,182,212,0.3)]' : 'text-white/40 hover:text-white'}`}
    >
      <Activity size={20} />
    </button>
    
    <button 
      onClick={() => onNavigate('player', { 
        name: 'Quick Start', 
        trackName: 'Instant Flow',
        color: 'from-green-400 to-cyan-500', 
        gradient: 'from-[#10b981] to-[#06b6d4]',
        audioSrc: 'https://actions.google.com/sounds/v1/water/waves_crashing.ogg'
      })} 
      className={`p-4 rounded-full bg-gradient-to-r from-cyan-500 to-purple-500 text-white transform -translate-y-6 shadow-[0_0_20px_rgba(139,92,246,0.5)] border border-white/20`}
    >
      <Play fill="currentColor" size={24} />
    </button>

    <button 
      onClick={() => onNavigate('settings')} 
      className={`p-3 rounded-full transition-all ${activeTab === 'settings' ? 'bg-white/10 text-purple-400 shadow-[0_0_15px_rgba(139,92,246,0.3)]' : 'text-white/40 hover:text-white'}`}
    >
      <Activity className="transform rotate-90" size={20} />
    </button>
  </div>
);

// --- MAIN APP COMPONENT ---
export default function NeuraSoundApp() {
  const [screen, setScreen] = useState('halo'); // 'halo', 'dashboard', 'player', 'settings'
  const [playerConfig, setPlayerConfig] = useState({ 
    name: 'Focus', 
    trackName: 'Ready',
    color: 'from-cyan-500 to-blue-600', 
    gradient: 'from-[#06b6d4] to-[#3b82f6]',
    audioSrc: '' 
  });

  const handleNavigate = (target, config = null) => {
    if (config) setPlayerConfig(config);
    setScreen(target);
  };

  if (screen === 'halo') {
    return (
      <>
        <GlobalStyles />
        <HaloSync onConnect={() => setScreen('dashboard')} />
      </>
    );
  }

  return (
    <div className="relative h-screen w-full bg-[#0B0F19] overflow-hidden text-white font-sans selection:bg-cyan-500/30">
      <GlobalStyles />
      <TopographicBg />

      <div className="relative z-10 h-full max-w-md mx-auto shadow-2xl bg-black/20 flex flex-col">
        {screen === 'dashboard' && <Dashboard navigate={handleNavigate} />}
        
        {screen === 'player' && (
          <MindPlayer 
            currentMode={playerConfig} 
            onBack={() => setScreen('dashboard')} 
          />
        )}
        
        {screen === 'settings' && <SensitivityLab onBack={() => setScreen('dashboard')} />}

        {/* Show Navbar only on dashboard or settings for easy nav */}
        {(screen === 'dashboard' || screen === 'settings') && (
          <NavBar activeTab={screen} onNavigate={handleNavigate} />
        )}
      </div>
    </div>
  );
}
